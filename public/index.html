<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WhatsApp API - Dev Console</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

  <!-- Top Header -->
  <div class="app-header">
    <div class="app-title">
      <i class="fab fa-whatsapp" style="color: var(--primary-color); font-size: 1.5rem;"></i>
      WA API Console
    </div>

    <div class="header-controls">
      <div class="client-selector-group">
        <select id="clientSelect" style="width: 200px;"></select>
        <button id="addClient" class="btn-icon" title="Add Client"><i class="fas fa-plus"></i></button>
        <button id="delClient" class="btn-icon" title="Delete Client"><i class="fas fa-trash"></i></button>
      </div>

      <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 10px;"></div>

      <div class="api-key-group" style="display:flex; gap:5px; align-items:center;">
        <input id="apiKeyDisplay" readonly placeholder="Select client for API Key"
          style="width: 180px; font-family: monospace; font-size: 0.8rem;">
        <button id="copyApiKey" class="btn-icon" title="Copy Key"><i class="fas fa-copy"></i></button>
        <button id="rotateApiKey" class="btn-icon" title="Rotate Key"><i class="fas fa-sync"></i></button>
        <button id="generateApiKey" class="btn-icon hidden" title="Generate New"><i class="fas fa-key"></i></button>
        <!-- Hidden by default as per old UI logic flows usually -->
      </div>

      <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 10px;"></div>

      <span style="font-size: 0.85rem; color: var(--text-secondary);">Status: <strong id="status"
          style="color: var(--primary-color);">-</strong></span>

      <form method="post" action="/logout" style="margin-left: 15px;">
        <button type="submit" class="btn-icon" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
      </form>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="app-container">

    <!-- Left Sidebar: QR & Chats -->
    <div class="sidebar">
      <div id="qr-container">
        <img id="qr" alt="QR" onerror="this.style.display='none'">
        <div style="margin-top:10px; font-size:0.9rem; color:var(--text-secondary)">Scan to authenticate</div>
      </div>

      <div class="sidebar-header">
        <div class="search-bar">
          <i class="fas fa-search" style="color: var(--text-secondary); margin-right: 10px;"></i>
          <input id="searchChats" placeholder="Search or start new chat" type="text">
        </div>
        <div id="chatSearchResult"
          style="font-size: 0.75rem; color: var(--text-secondary); padding: 5px 0 0 5px; height: 20px;"></div>
        <button id="newChatBtn"
          style="width:100%; margin-top:5px; font-size:0.8rem; background: var(--primary-color); color: white;">üí¨ New
          Chat</button>
        <button id="refreshChats" style="width:100%; margin-top:5px; font-size:0.8rem;">üîÑ Reload List</button>
      </div>

      <div id="chats" class="sidebar-content">
        <!-- Chat items will be injected here -->
      </div>
    </div>

    <!-- Center: Main Chat -->
    <div class="main-chat">
      <div class="chat-header">
        <div class="chat-title-container">
          <div class="chat-avatar" style="width:40px;height:40px;">
            <!-- Placeholder or active chat logic can update this -->
            <img src="https://via.placeholder.com/40" style="display:none" id="headerAvatar">
            <div
              style="width:100%;height:100%;background:#555;display:flex;align-items:center;justify-content:center;color:#fff">
              <i class="fas fa-user"></i>
            </div>
          </div>
          <div style="display:flex; flex-direction:column;">
            <h3 id="chatTitle" style="font-size:1rem;font-weight:500;margin:0;line-height:1.2">Select a chat</h3>
            <span id="chatInfo" style="display:none"></span> <!-- Hidden raw JSON, keeping ID for compatibility -->
          </div>
        </div>
        <div class="chat-header-actions">
          <div class="search-bar" style="width: 200px;">
            <input id="searchMessages" placeholder="Search messages..." type="text">
          </div>
          <div id="messageSearchResult" style="display:none"></div>
        </div>
      </div>

      <div id="messages" class="messages-container"></div>

      <div class="chat-footer">
        <div style="width: 30px; display:flex; flex-direction:column; gap: 5px; margin-right:5px">
          <button title="Upload Media" onclick="document.getElementById('mediaFile').click()" class="btn-icon"><i
              class="fas fa-paperclip"></i></button>
          <input type="file" id="mediaFile" accept="image/*,video/*" style="display:none">
        </div>

        <div class="input-group">
          <textarea id="message" placeholder="Type a message" rows="1"></textarea>
          <!-- Mentions input will be injected here by app.js -->
        </div>

        <button id="send" class="btn-icon primary" style="width:45px;height:45px;border-radius:50%;"><i
            class="fas fa-paper-plane"></i></button>
        <button id="sendMedia" class="hidden">Send Media</button>
        <!-- Hidden logic button, app.js might use it directly or we trigger it via new UI -->
      </div>

      <!-- Hidden/Utility Elements needed by app.js -->
      <div id="mediaInfo"
        style="position:absolute; bottom:70px; left:20px; background:#333; padding:5px; font-size:0.8rem; border-radius:4px; display:none;">
      </div>
      <div style="position:absolute; bottom:80px; right:20px; display:flex; gap:10px;">
        <button id="prevMessages" class="small" style="opacity:0.7">Scroll Up</button>
        <button id="nextMessages" class="small" style="opacity:0.7">Scroll Down</button>
        <button id="exportMessages" class="small" style="opacity:0.7"><i class="fas fa-download"></i></button>
      </div>

    </div>

    <!-- Right: Developer Tools -->
    <div class="right-panel">

      <!-- Chat Actions (Always visible when chat selected) -->
      <div id="chatActions" class="panel-section" style="display:none;">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üí¨ Chat Actions</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="blockContactBtn" style="background:#dc3545;color:#fff;"><i class="fas fa-ban"></i> Block</button>
          <button id="unblockContactBtn" style="background:#28a745;color:#fff;"><i class="fas fa-check"></i>
            Unblock</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="archiveChatBtn"><i class="fas fa-archive"></i> Archive</button>
          <button id="unarchiveChatBtn"><i class="fas fa-box-open"></i> Unarchive</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="pinChatBtn"><i class="fas fa-thumbtack"></i> Pin</button>
          <button id="unpinChatBtn"><i class="fas fa-times"></i> Unpin</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
          <button id="markSeenBtn"><i class="fas fa-check-double"></i> Read</button>
          <button id="markUnreadBtn"><i class="fas fa-envelope"></i> Unread</button>
        </div>
      </div>

      <!-- Search Messages -->
      <div class="panel-section">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üîç Search Messages</h4>
        <input id="searchMsgInput" placeholder="Search query..." style="width:100%; margin-bottom:8px;">
        <button id="searchMsgBtn" style="width:100%;"><i class="fas fa-search"></i> Search</button>
        <div id="searchMsgResults" style="max-height:80px; overflow:auto; font-size:0.75rem; margin-top:8px;"></div>
      </div>

      <!-- My Status -->
      <div class="panel-section">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üìù My Status</h4>
        <input id="myStatusInput" placeholder="Enter your status message..." style="width:100%; margin-bottom:8px;">
        <button id="setStatusBtn" style="width:100%;"><i class="fas fa-edit"></i> Set Status</button>
      </div>

      <!-- Message Actions -->
      <div id="messageActions" class="panel-section" style="display:none;">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üì§ Send Special</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
          <button id="sendLocationBtn"><i class="fas fa-map-marker-alt"></i> Location</button>
          <button id="sendContactBtn"><i class="fas fa-address-card"></i> Contact</button>
          <button id="sendPollBtn"><i class="fas fa-poll"></i> Poll</button>
          <button id="sendStickerBtn"><i class="fas fa-sticky-note"></i> Sticker</button>
        </div>
      </div>


      <!-- Group Tools (Enhanced) -->
      <div id="groupActions" class="panel-section" style="display:none;">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üë• Group Tools</h4>

        <!-- Create Group -->
        <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:5px;">Create New
          Group</label>
        <input id="newGroupTitle" placeholder="Group title" style="width:100%; margin-bottom:5px;">
        <input id="newGroupParticipants" placeholder="Participants (comma-separated IDs)"
          style="width:100%; margin-bottom:8px;">
        <button id="createGroupBtn"
          style="width:100%; margin-bottom:10px; background:var(--primary-color); color:#fff;"><i
            class="fas fa-plus"></i> Create Group</button>

        <hr style="border:none; border-top:1px solid #333; margin:15px 0;">

        <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:5px;">Participants
          (IDs)</label>
        <input id="participants" placeholder="id1@c.us, id2@c.us" style="width:100%; margin-bottom:10px;">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="addParticipants"><i class="fas fa-user-plus"></i> Add</button>
          <button id="removeParticipants"><i class="fas fa-user-minus"></i> Remove</button>
          <button id="promoteParticipants"><i class="fas fa-angle-double-up"></i> Promote</button>
          <button id="demoteParticipants"><i class="fas fa-angle-double-down"></i> Demote</button>
        </div>

        <button id="loadParticipants" style="width:100%; margin-bottom:8px;">List Participants</button>
        <pre id="participantsList"
          style="background:var(--input-bg); margin-top:5px; max-height:100px; overflow:auto; font-size:0.75rem; padding:5px;"></pre>

        <hr style="border:none; border-top:1px solid #333; margin:15px 0;">

        <!-- Group Invite -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="getInviteLinkBtn"><i class="fas fa-link"></i> Get Link</button>
          <button id="revokeInviteLinkBtn"><i class="fas fa-redo"></i> Revoke</button>
        </div>
        <input id="inviteLinkDisplay" readonly placeholder="Invite link will appear here..."
          style="width:100%; margin-bottom:10px; font-size:0.75rem;">

        <!-- Join Group -->
        <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:5px;">Join Group by
          Invite</label>
        <input id="joinGroupInput" placeholder="Paste invite link or code" style="width:100%; margin-bottom:8px;">
        <button id="joinGroupBtn" style="width:100%; margin-bottom:10px;"><i class="fas fa-sign-in-alt"></i> Join
          Group</button>

        <!-- Edit Group Info -->
        <hr style="border:none; border-top:1px solid #333; margin:15px 0;">
        <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:5px;">Edit
          Group</label>
        <input id="groupSubjectInput" placeholder="New group name" style="width:100%; margin-bottom:5px;">
        <textarea id="groupDescInput" placeholder="New group description" rows="2"
          style="width:100%; margin-bottom:8px; resize:none;"></textarea>
        <button id="updateGroupInfoBtn" style="width:100%;"><i class="fas fa-save"></i> Update Info</button>
      </div>

      <!-- Channel Management -->
      <div class="panel-section">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üì¢ Channels</h4>
        <input id="channelSearchInput" placeholder="Search channels..." style="width:100%; margin-bottom:8px;">
        <button id="searchChannelsBtn" style="width:100%; margin-bottom:10px;"><i class="fas fa-search"></i>
          Search</button>
        <div id="channelSearchResults" style="max-height:100px; overflow:auto; font-size:0.75rem; margin-bottom:10px;">
        </div>

        <hr style="border:none; border-top:1px solid #333; margin:10px 0;">
        <button id="createChannelBtn" style="width:100%; background:var(--primary-color); color:#fff;"><i
            class="fas fa-plus"></i> Create Channel</button>
      </div>

      <!-- Events Log -->
      <div class="panel-section">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">üìã Events Log</h4>
        <pre id="events"></pre>
      </div>

    </div>
  </div>

  <!-- New Chat Modal -->
  <div id="newChatModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div
      style="background:var(--background-color); padding:30px; border-radius:12px; width:90%; max-width:500px; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--text-color); font-size:1.3rem;">üí¨ Start New Chat</h3>
        <button id="closeNewChatModal"
          style="background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer; padding:0; line-height:1;">&times;</button>
      </div>

      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:8px; color:var(--text-secondary); font-size:0.9rem;">Phone
          Number</label>
        <input id="newChatPhone" type="text" placeholder="e.g. 081234567890 or 6281234567890"
          style="width:100%; padding:12px; font-size:1rem; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color);">
        <small style="color:var(--text-secondary); font-size:0.75rem; margin-top:5px; display:block;">Enter phone number
          with country code (62 for Indonesia)</small>
      </div>

      <div style="margin-bottom:25px;">
        <label style="display:block; margin-bottom:8px; color:var(--text-secondary); font-size:0.9rem;">Message</label>
        <textarea id="newChatMessage" rows="4" placeholder="Type your first message here..."
          style="width:100%; padding:12px; font-size:1rem; border-radius:6px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-color); resize:vertical;"></textarea>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="cancelNewChat"
          style="padding:10px 20px; font-size:0.95rem; border-radius:6px; cursor:pointer; background:var(--input-bg); color:var(--text-color); border:1px solid var(--border-color);">Cancel</button>
        <button id="sendNewChat"
          style="padding:10px 20px; font-size:0.95rem; border-radius:6px; cursor:pointer; background:var(--primary-color); color:white; border:none; font-weight:500;">Send
          Message</button>
      </div>
    </div>
  </div>

  <!-- Send Location Modal -->
  <div id="locationModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content"
      style="background:var(--background-color); padding:30px; border-radius:12px; width:90%; max-width:400px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--text-color);">üìç Send Location</h3>
        <button class="modal-close"
          style="background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer;">&times;</button>
      </div>
      <input id="locationLat" type="number" step="any" placeholder="Latitude (e.g. -6.2088)"
        style="width:100%; padding:10px; margin-bottom:10px;">
      <input id="locationLng" type="number" step="any" placeholder="Longitude (e.g. 106.8456)"
        style="width:100%; padding:10px; margin-bottom:10px;">
      <input id="locationAddress" type="text" placeholder="Address (optional)"
        style="width:100%; padding:10px; margin-bottom:15px;">
      <button id="sendLocationSubmit"
        style="width:100%; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px; cursor:pointer;">Send
        Location</button>
    </div>
  </div>

  <!-- Send Contact Modal -->
  <div id="contactModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content"
      style="background:var(--background-color); padding:30px; border-radius:12px; width:90%; max-width:400px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--text-color);">üë§ Send Contact</h3>
        <button class="modal-close"
          style="background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer;">&times;</button>
      </div>
      <input id="contactNumber" type="text" placeholder="Contact number (e.g. 6281234567890@c.us)"
        style="width:100%; padding:10px; margin-bottom:10px;">
      <input id="contactName" type="text" placeholder="Display name (optional)"
        style="width:100%; padding:10px; margin-bottom:15px;">
      <button id="sendContactSubmit"
        style="width:100%; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px; cursor:pointer;">Send
        Contact</button>
    </div>
  </div>

  <!-- Send Poll Modal -->
  <div id="pollModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content"
      style="background:var(--background-color); padding:30px; border-radius:12px; width:90%; max-width:450px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--text-color);">üìä Create Poll</h3>
        <button class="modal-close"
          style="background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer;">&times;</button>
      </div>
      <input id="pollQuestion" type="text" placeholder="Poll question"
        style="width:100%; padding:10px; margin-bottom:10px;">
      <textarea id="pollOptions" placeholder="Options (one per line, min 2)" rows="4"
        style="width:100%; padding:10px; margin-bottom:10px; resize:none;"></textarea>
      <label
        style="display:flex; align-items:center; gap:8px; margin-bottom:15px; color:var(--text-secondary); font-size:0.9rem;">
        <input type="checkbox" id="pollMultiple"> Allow multiple answers
      </label>
      <button id="sendPollSubmit"
        style="width:100%; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px; cursor:pointer;">Send
        Poll</button>
    </div>
  </div>

  <!-- Create Channel Modal -->
  <div id="channelModal" class="modal-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div class="modal-content"
      style="background:var(--background-color); padding:30px; border-radius:12px; width:90%; max-width:400px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--text-color);">üì¢ Create Channel</h3>
        <button class="modal-close"
          style="background:none; border:none; font-size:1.8rem; color:var(--text-secondary); cursor:pointer;">&times;</button>
      </div>
      <input id="channelTitle" type="text" placeholder="Channel title"
        style="width:100%; padding:10px; margin-bottom:10px;">
      <textarea id="channelDesc" placeholder="Channel description (optional)" rows="3"
        style="width:100%; padding:10px; margin-bottom:15px; resize:none;"></textarea>
      <button id="createChannelSubmit"
        style="width:100%; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px; cursor:pointer;">Create
        Channel</button>
    </div>
  </div>

  <!-- Sticker File Input (hidden) -->
  <input type="file" id="stickerFile" accept=".webp,image/webp" style="display:none;">

  <script src="/app.js?v=5"></script>
  <script>
    // Minimal glue to handle the file upload UI which I made hidden
    const fileInput = document.getElementById('mediaFile');
    const mediaInfo = document.getElementById('mediaInfo');
    const sendMediaBtn = document.getElementById('sendMedia');

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        mediaInfo.textContent = `File selected: ${fileInput.files[0].name}`;
        mediaInfo.style.display = 'block';
        // Auto-show a visible "Send Media" action or just hijack the main send button's logic?
        // For simplicity in this layout, let's just trigger the click on the old (hidden) button 
        // when the user hits a new specific button, OR just show the hidden button.
        // Let's make the hidden "Send Media" button appear in the chat footer temporarily.
        sendMediaBtn.classList.remove('hidden');
        sendMediaBtn.className = 'btn-icon primary';
        sendMediaBtn.innerHTML = '<i class="fas fa-file-import"></i>';
        // hide text send button
        document.getElementById('send').style.display = 'none';
      }
    });

    // Hook reset of media ui into the existing listener via app.js modification or observation? 
    // app.js clears file input value. We can observe that.
    // Or just let it be. simpler:
    const originalSendMedia = sendMediaBtn.onclick; // wait, app.js assigns this later.

    // UI Helpers
    document.getElementById('qr').onload = function () {
      document.getElementById('qr-container').style.display = 'block';
    }
    // If qr hides, hide container
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (mutation.type == "attributes" && mutation.attributeName == "style") {
          document.getElementById('qr-container').style.display = document.getElementById('qr').style.display;
        }
      });
    });
    observer.observe(document.getElementById('qr'), { attributes: true });

  </script>
</body>

</html>