<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WhatsApp API - Dev Console</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  
  <!-- Top Header -->
  <div class="app-header">
    <div class="app-title">
      <i class="fab fa-whatsapp" style="color: var(--primary-color); font-size: 1.5rem;"></i>
      WA API Console
    </div>
    
    <div class="header-controls">
      <div class="client-selector-group">
        <select id="clientSelect" style="width: 200px;"></select>
        <button id="addClient" class="btn-icon" title="Add Client"><i class="fas fa-plus"></i></button>
        <button id="delClient" class="btn-icon" title="Delete Client"><i class="fas fa-trash"></i></button>
      </div>
      
      <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 10px;"></div>

      <div class="api-key-group" style="display:flex; gap:5px; align-items:center;">
        <input id="apiKeyDisplay" readonly placeholder="Select client for API Key" style="width: 180px; font-family: monospace; font-size: 0.8rem;">
        <button id="copyApiKey" class="btn-icon" title="Copy Key"><i class="fas fa-copy"></i></button>
        <button id="rotateApiKey" class="btn-icon" title="Rotate Key"><i class="fas fa-sync"></i></button>
        <button id="generateApiKey" class="btn-icon hidden" title="Generate New"><i class="fas fa-key"></i></button> <!-- Hidden by default as per old UI logic flows usually -->
      </div>

      <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 10px;"></div>
      
      <span style="font-size: 0.85rem; color: var(--text-secondary);">Status: <strong id="status" style="color: var(--primary-color);">-</strong></span>
      
      <form method="post" action="/logout" style="margin-left: 15px;">
        <button type="submit" class="btn-icon" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
      </form>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="app-container">
    
    <!-- Left Sidebar: QR & Chats -->
    <div class="sidebar">
      <div id="qr-container">
        <img id="qr" alt="QR" onerror="this.style.display='none'">
        <div style="margin-top:10px; font-size:0.9rem; color:var(--text-secondary)">Scan to authenticate</div>
      </div>

      <div class="sidebar-header">
        <div class="search-bar">
          <i class="fas fa-search" style="color: var(--text-secondary); margin-right: 10px;"></i>
          <input id="searchChats" placeholder="Search or start new chat" type="text">
        </div>
        <div id="chatSearchResult" style="font-size: 0.75rem; color: var(--text-secondary); padding: 5px 0 0 5px; height: 20px;"></div>
        <button id="refreshChats" style="width:100%; margin-top:5px; font-size:0.8rem;">ðŸ”„ Reload List</button>
      </div>

      <div id="chats" class="sidebar-content">
        <!-- Chat items will be injected here -->
      </div>
    </div>

    <!-- Center: Main Chat -->
    <div class="main-chat">
      <div class="chat-header">
        <div class="chat-title-container">
          <div class="chat-avatar" style="width:40px;height:40px;">
             <!-- Placeholder or active chat logic can update this -->
             <img src="https://via.placeholder.com/40" style="display:none" id="headerAvatar">
             <div style="width:100%;height:100%;background:#555;display:flex;align-items:center;justify-content:center;color:#fff"><i class="fas fa-user"></i></div>
          </div>
          <div style="display:flex; flex-direction:column;">
            <h3 id="chatTitle" style="font-size:1rem;font-weight:500;margin:0;line-height:1.2">Select a chat</h3>
            <span id="chatInfo" style="display:none"></span> <!-- Hidden raw JSON, keeping ID for compatibility -->
          </div>
        </div>
        <div class="chat-header-actions">
           <div class="search-bar" style="width: 200px;">
             <input id="searchMessages" placeholder="Search messages..." type="text">
           </div>
           <div id="messageSearchResult" style="display:none"></div>
        </div>
      </div>

      <div id="messages" class="messages-container"></div>

      <div class="chat-footer">
        <div style="width: 30px; display:flex; flex-direction:column; gap: 5px; margin-right:5px">
             <button title="Upload Media" onclick="document.getElementById('mediaFile').click()" class="btn-icon"><i class="fas fa-paperclip"></i></button>
             <input type="file" id="mediaFile" accept="image/*,video/*" style="display:none">
        </div>
        
        <div class="input-group">
          <textarea id="message" placeholder="Type a message" rows="1"></textarea>
           <!-- Mentions input will be injected here by app.js -->
        </div>

        <button id="send" class="btn-icon primary" style="width:45px;height:45px;border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
        <button id="sendMedia" class="hidden">Send Media</button> <!-- Hidden logic button, app.js might use it directly or we trigger it via new UI -->
      </div>
      
      <!-- Hidden/Utility Elements needed by app.js -->
      <div id="mediaInfo" style="position:absolute; bottom:70px; left:20px; background:#333; padding:5px; font-size:0.8rem; border-radius:4px; display:none;"></div>
      <div style="position:absolute; bottom:80px; right:20px; display:flex; gap:10px;">
          <button id="prevMessages" class="small" style="opacity:0.7">Scroll Up</button>
          <button id="nextMessages" class="small" style="opacity:0.7">Scroll Down</button>
          <button id="exportMessages" class="small" style="opacity:0.7"><i class="fas fa-download"></i></button>
      </div>

    </div>

    <!-- Right: Developer Tools -->
    <div class="right-panel">
      
      <div class="panel-section">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">Events Log</h4>
        <pre id="events"></pre>
      </div>

      <div id="groupActions" class="panel-section" style="display:none;">
        <h4 style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">Group Tools</h4>
        
        <label style="font-size:0.8rem; color:var(--text-secondary); display:block; margin-bottom:5px;">Participants (IDs)</label>
        <input id="participants" placeholder="id1@c.us, id2@c.us" style="width:100%; margin-bottom:10px;">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
          <button id="addParticipants"><i class="fas fa-user-plus"></i> Add</button>
          <button id="removeParticipants"><i class="fas fa-user-minus"></i> Remove</button>
          <button id="promoteParticipants"><i class="fas fa-angle-double-up"></i> Promote</button>
          <button id="demoteParticipants"><i class="fas fa-angle-double-down"></i> Demote</button>
        </div>
        
        <button id="loadParticipants" style="width:100%;">List Participants</button>
        <pre id="participantsList" style="background:var(--input-bg); margin-top:10px; max-height:150px; overflow:auto; font-size:0.75rem; padding:5px;"></pre>
      </div>

    </div>
  </div>

  <script src="/app.js?v=4"></script>
  <script>
    // Minimal glue to handle the file upload UI which I made hidden
    const fileInput = document.getElementById('mediaFile');
    const mediaInfo = document.getElementById('mediaInfo');
    const sendMediaBtn = document.getElementById('sendMedia');
    
    fileInput.addEventListener('change', () => {
      if(fileInput.files.length > 0) {
        mediaInfo.textContent = `File selected: ${fileInput.files[0].name}`;
        mediaInfo.style.display = 'block';
        // Auto-show a visible "Send Media" action or just hijack the main send button's logic?
        // For simplicity in this layout, let's just trigger the click on the old (hidden) button 
        // when the user hits a new specific button, OR just show the hidden button.
        // Let's make the hidden "Send Media" button appear in the chat footer temporarily.
        sendMediaBtn.classList.remove('hidden');
        sendMediaBtn.className = 'btn-icon primary';
        sendMediaBtn.innerHTML = '<i class="fas fa-file-import"></i>';
        // hide text send button
        document.getElementById('send').style.display = 'none';
      }
    });

    // Hook reset of media ui into the existing listener via app.js modification or observation? 
    // app.js clears file input value. We can observe that.
    // Or just let it be. simpler:
    const originalSendMedia = sendMediaBtn.onclick; // wait, app.js assigns this later.
    
    // UI Helpers
    document.getElementById('qr').onload = function() {
       document.getElementById('qr-container').style.display = 'block';
    }
    // If qr hides, hide container
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type == "attributes" && mutation.attributeName == "style") {
                 document.getElementById('qr-container').style.display = document.getElementById('qr').style.display;
            }
        });
    });
    observer.observe(document.getElementById('qr'), { attributes: true });

  </script>
</body>
</html>
